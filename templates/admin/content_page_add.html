{% extends 'admin/base.html' %}
{% block title %}Add Content Page{% endblock %}
{% block page_title %}Add New Content Page{% endblock %}
{% block extra_css %}

<style>
    .preview-image {
        max-width: 300px;
        max-height: 200px;
        margin-top: 10px;
        border-radius: 8px;
        display: none;
    }

    .char-counter {
        font-size: 0.85rem;
        color: #6c757d;
        float: right;
    }

    .form-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .form-section h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
    }

    /* CKEditor custom styling */
    .django-ckeditor-widget {
        width: 100% !important;
    }

    .cke_chrome {
        border: 1px solid #ced4da !important;
        border-radius: 0.25rem !important;
    }
</style>

{% endblock %}

{% block content %}

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">Content Page Information</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Display form errors -->
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <strong>Please correct the following errors:</strong>
                        <ul class="mb-0 mt-2">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                <li>{{ field }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- BASIC INFO SECTION -->
                    <div class="form-section">
                        <h6><i class="bi bi-info-circle me-2"></i>Basic Information</h6>

                        <div class="row">
                            <!-- Sub-Category -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Sub-Category</label>
                                <input type="text" class="form-control"
                                    value="{{ sub_category.parent_card.title }} â†’ {{ sub_category.title }}" readonly>
                                {{ form.sub_category.as_hidden }}
                            </div>

                            <!-- Title -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Page Title <span class="text-danger">*</span></label>
                                {{ form.title }}
                                <span class="char-counter">
                                    <span id="titleCount">0</span>/300 characters
                                </span>
                            </div>

                            <!-- Slug (optional) -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label">URL Slug (Optional - Auto-generated from title)</label>
                                {{ form.slug }}
                                <small class="text-muted">Leave blank for auto-generation. Used in URL.</small>
                            </div>

                            <!-- Summary -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Summary (Optional)</label>
                                {{ form.summary }}
                                <span class="char-counter">
                                    <span id="summaryCount">0</span>/500 characters
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- CONTENT SECTION -->
                    <div class="form-section">
                        <h6><i class="bi bi-file-text me-2"></i>Page Content</h6>

                        <div class="row">
                            <!-- Main Content with CKEditor -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Full Content <span class="text-danger">*</span></label>
                                {{ form.media }}
                                {{ form.content }}
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i>
                                    Use the rich text editor above to format your content with headings, lists, links, images, and more.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- FEATURED IMAGE SECTION -->
                    <div class="form-section">
                        <h6><i class="bi bi-image me-2"></i>Featured Image</h6>

                        <div class="row">
                            <!-- Upload Image -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Upload Featured Image</label>
                                {{ form.featured_image }}
                                <small class="text-muted">Recommended: 800x400px or 16:9 ratio</small>
                            </div>

                            <!-- OR Image URL -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">OR Image URL</label>
                                {{ form.featured_image_url }}
                            </div>

                            <!-- Image Preview -->
                            <div class="col-md-12 mb-3">
                                <img id="imagePreview" class="preview-image" alt="Preview">
                            </div>
                        </div>
                    </div>

                    <!-- SEO SECTION -->
                    <div class="form-section">
                        <h6><i class="bi bi-search me-2"></i>SEO Settings (Optional)</h6>

                        <div class="row">
                            <!-- Meta Description -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Meta Description</label>
                                {{ form.meta_description }}
                                <span class="char-counter">
                                    <span id="metaCount">0</span>/160 characters
                                </span>
                                <small class="text-muted">Appears in search engine results</small>
                            </div>

                            <!-- Meta Keywords -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Meta Keywords</label>
                                {{ form.meta_keywords }}
                                <small class="text-muted">Comma separated keywords</small>
                            </div>
                        </div>
                    </div>

                    <!-- DISPLAY SETTINGS SECTION -->
                    <div class="form-section">
                        <h6><i class="bi bi-gear me-2"></i>Display Settings</h6>

                        <div class="row">
                            <!-- Order -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Display Order</label>
                                {{ form.order }}
                                <small class="text-muted">Lower numbers appear first</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <!-- Empty space -->
                            </div>

                            <!-- Active Status -->
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="id_is_active">
                                        <strong>Active</strong> (Show on website)
                                    </label>
                                </div>
                            </div>

                            <!-- Featured -->
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    {{ form.is_featured }}
                                    <label class="form-check-label" for="id_is_featured">
                                        <strong>Featured</strong> (Highlight this page)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BUTTONS -->
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Create Page
                        </button>
                        <a href="{% url 'main_app:admin_content_pages_by_subcategory' sub_category.id %}"
                            class="btn btn-secondary">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}

<script>
    // Character counters
    const titleInput = document.querySelector('input[name="title"]');
    const titleCount = document.getElementById('titleCount');
    const summaryInput = document.querySelector('textarea[name="summary"]');
    const summaryCount = document.getElementById('summaryCount');
    const metaInput = document.querySelector('input[name="meta_description"]');
    const metaCount = document.getElementById('metaCount');

    if (titleInput) {
        titleInput.addEventListener('input', function () {
            titleCount.textContent = this.value.length;
        });
        titleCount.textContent = titleInput.value.length;
    }

    if (summaryInput) {
        summaryInput.addEventListener('input', function () {
            summaryCount.textContent = this.value.length;
        });
        summaryCount.textContent = summaryInput.value.length;
    }

    if (metaInput) {
        metaInput.addEventListener('input', function () {
            metaCount.textContent = this.value.length;
        });
        metaCount.textContent = metaInput.value.length;
    }

    // Image preview
    const imageUpload = document.querySelector('input[name="featured_image"]');
    const imageUrl = document.querySelector('input[name="featured_image_url"]');
    const imagePreview = document.getElementById('imagePreview');

    function updatePreview(src) {
        if (src) {
            imagePreview.src = src;
            imagePreview.style.display = 'block';
        } else {
            imagePreview.style.display = 'none';
        }
    }

    if (imageUpload) {
        imageUpload.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    updatePreview(e.target.result);
                }
                reader.readAsDataURL(file);
            }
        });
    }

    if (imageUrl) {
        imageUrl.addEventListener('input', function () {
            updatePreview(this.value);
        });
    }
</script>

{% endblock %}