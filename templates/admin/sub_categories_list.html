{% extends 'admin/base.html' %}
{% block title %}Sub-Categories{% endblock %}
{% block page_title %}All Sub-Categories{% endblock %}

{% block extra_css %}
<style>
    .subcategory-card {
        transition: all 0.3s ease;
        border-left: 4px solid #e9ecef;
    }
    
    .subcategory-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-left-color: #0d6efd;
    }
    
    .subcategory-card.inactive {
        opacity: 0.6;
        background-color: #f8f9fa;
    }
    
    .subcategory-icon {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .subcategory-icon img {
        width: 60px;
        height: 60px;
        object-fit: contain;
    }
    
    .badge-status {
        font-size: 0.75rem;
        padding: 0.35rem 0.65rem;
    }
    
    .parent-badge {
        background-color: #e7f1ff;
        color: #0c63e4;
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .action-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
    }
    
    .search-box {
        max-width: 400px;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .stats-item {
        text-align: center;
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: bold;
        display: block;
    }
    
    .stats-label {
        font-size: 0.875rem;
        opacity: 0.9;
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        opacity: 0.3;
        margin-bottom: 1rem;
    }

    .filter-badge {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        margin-right: 0.3rem;
        margin-bottom: 0.3rem;
    }

    .filter-badge.state {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .filter-badge.course {
        background-color: #fff3cd;
        color: #856404;
    }

    .page-count {
        background-color: #d4edda;
        color: #155724;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}

<!-- Stats Overview -->
<div class="stats-card">
    <div class="row">
        <div class="col-md-3 stats-item">
            <span class="stats-number">{{ total_subcategories }}</span>
            <span class="stats-label">Total Sub-Categories</span>
        </div>
        <div class="col-md-3 stats-item">
            <span class="stats-number">{{ active_subcategories }}</span>
            <span class="stats-label">Active</span>
        </div>
        <div class="col-md-3 stats-item">
            <span class="stats-number">{{ inactive_subcategories }}</span>
            <span class="stats-label">Inactive</span>
        </div>
        <div class="col-md-3 stats-item">
            <span class="stats-number">{{ total_pages }}</span>
            <span class="stats-label">Total Content Pages</span>
        </div>
    </div>
</div>

<!-- Header with Search and Add Button -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="input-group search-box">
                    <span class="input-group-text bg-white">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Search sub-categories...">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group me-2" role="group">
                    <button type="button" class="btn btn-outline-secondary active" id="filterAll">
                        All ({{ total_subcategories }})
                    </button>
                    <button type="button" class="btn btn-outline-success" id="filterActive">
                        Active ({{ active_subcategories }})
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="filterInactive">
                        Inactive ({{ inactive_subcategories }})
                    </button>
                </div>
                <a href="{% url 'main_app:admin_sub_category_add' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>Add Sub-Category
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Sub-Categories List -->
<div class="row" id="subcategoriesList">
    {% if sub_categories %}
        {% for subcategory in sub_categories %}
        <div class="col-12 mb-3 subcategory-item" 
             data-status="{{ subcategory.is_active|lower }}"
             data-title="{{ subcategory.title|lower }}"
             data-parent="{{ subcategory.parent_card.title|lower }}">
            <div class="card subcategory-card {% if not subcategory.is_active %}inactive{% endif %}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- Icon -->
                        <div class="col-auto">
                            <div class="subcategory-icon" 
                                 {% if subcategory.icon_color %}
                                 style="background: {{ subcategory.icon_color }};"
                                 {% endif %}>
                                {% if subcategory.icon_image %}
                                    <img src="{{ subcategory.icon_image.url }}" alt="{{ subcategory.title }}">
                                {% elif subcategory.icon_url %}
                                    <img src="{{ subcategory.icon_url }}" alt="{{ subcategory.title }}">
                                {% else %}
                                    <i class="bi bi-folder"></i>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Content Details -->
                        <div class="col">
                            <div class="d-flex align-items-start justify-content-between">
                                <div class="flex-grow-1">
                                    <h5 class="mb-1">{{ subcategory.title }}</h5>
                                    
                                    <div class="mb-2">
                                        <span class="parent-badge">
                                            <i class="bi bi-card-list me-1"></i>
                                            {{ subcategory.parent_card.title }}
                                        </span>
                                        
                                        {% if subcategory.state %}
                                            <span class="filter-badge state">
                                                <i class="bi bi-geo-alt"></i> {{ subcategory.state.name }}
                                            </span>
                                        {% endif %}
                                        
                                        {% if subcategory.course %}
                                            <span class="filter-badge course">
                                                <i class="bi bi-book"></i> {{ subcategory.get_course_display }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    {% if subcategory.description %}
                                        <p class="text-muted mb-2 small">{{ subcategory.description|truncatewords:25 }}</p>
                                    {% endif %}
                                    
                                    <div class="small text-muted">
                                        <i class="bi bi-link-45deg"></i>
                                        <code>/{{ subcategory.slug }}</code>
                                        <span class="ms-3">
                                            <i class="bi bi-sort-numeric-down"></i>
                                            Order: {{ subcategory.order }}
                                        </span>
                                        <span class="ms-3">
                                            <i class="bi bi-calendar-event"></i>
                                            {{ subcategory.created_at|date:"d M, Y" }}
                                        </span>
                                        {% if subcategory.created_by %}
                                            <span class="ms-3">
                                                <i class="bi bi-person"></i>
                                                {{ subcategory.created_by.get_full_name|default:subcategory.created_by.username }}
                                            </span>
                                        {% endif %}
                                        <span class="ms-3 page-count">
                                            <i class="bi bi-file-text"></i>
                                            {{ subcategory.content_pages.count }} page{{ subcategory.content_pages.count|pluralize }}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Status and Actions -->
                                <div class="text-end ms-3">
                                    <div class="mb-2">
                                        {% if subcategory.is_active %}
                                            <span class="badge bg-success badge-status">
                                                <i class="bi bi-check-circle"></i> Active
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary badge-status">
                                                <i class="bi bi-x-circle"></i> Inactive
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="btn-group" role="group">
                                        <!--  -->
                                        <a href="{% url 'main_app:admin_sub_category_edit' subcategory.pk %}" 
                                           class="btn btn-sm btn-outline-primary action-btn"
                                           title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'main_app:admin_sub_category_delete' subcategory.pk %}" 
                                           class="btn btn-sm btn-outline-danger action-btn"
                                           onclick="return confirm('Are you sure you want to delete this sub-category? This will also delete all associated pages!')"
                                           title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="empty-state">
                <i class="bi bi-folder-x"></i>
                <h4>No Sub-Categories Yet</h4>
                <p class="text-muted">Start by creating your first sub-category.</p>
                <a href="{% url 'main_app:admin_sub_category_add' %}" class="btn btn-primary mt-3">
                    <i class="bi bi-plus-circle me-2"></i>Add Sub-Category
                </a>
            </div>
        </div>
    {% endif %}
</div>

<!-- Empty State for No Results -->
<div class="col-12 d-none" id="noResults">
    <div class="empty-state">
        <i class="bi bi-search"></i>
        <h5>No sub-categories found</h5>
        <p class="text-muted">Try adjusting your search or filter criteria.</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const subcategoryItems = document.querySelectorAll('.subcategory-item');
    const noResults = document.getElementById('noResults');
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        let visibleCount = 0;
        
        subcategoryItems.forEach(item => {
            const title = item.dataset.title;
            const parent = item.dataset.parent;
            const isVisible = !item.classList.contains('d-none');
            
            if (title.includes(searchTerm) || parent.includes(searchTerm)) {
                if (isVisible) {
                    item.classList.remove('d-none');
                    visibleCount++;
                }
            } else {
                item.classList.add('d-none');
            }
        });
        
        // Show/hide no results message
        if (visibleCount === 0) {
            noResults.classList.remove('d-none');
        } else {
            noResults.classList.add('d-none');
        }
    });
    
    // Filter functionality
    const filterButtons = {
        all: document.getElementById('filterAll'),
        active: document.getElementById('filterActive'),
        inactive: document.getElementById('filterInactive')
    };
    
    function setActiveFilter(button) {
        Object.values(filterButtons).forEach(btn => {
            btn.classList.remove('active');
            btn.classList.add('btn-outline-secondary');
            btn.classList.remove('btn-success');
        });
        button.classList.add('active');
    }
    
    filterButtons.all.addEventListener('click', function() {
        setActiveFilter(this);
        subcategoryItems.forEach(item => item.classList.remove('d-none'));
        searchInput.value = '';
        noResults.classList.add('d-none');
    });
    
    filterButtons.active.addEventListener('click', function() {
        setActiveFilter(this);
        this.classList.remove('btn-outline-secondary');
        this.classList.add('btn-success');
        
        let visibleCount = 0;
        subcategoryItems.forEach(item => {
            if (item.dataset.status === 'true') {
                item.classList.remove('d-none');
                visibleCount++;
            } else {
                item.classList.add('d-none');
            }
        });
        
        searchInput.value = '';
        noResults.classList.toggle('d-none', visibleCount > 0);
    });
    
    filterButtons.inactive.addEventListener('click', function() {
        setActiveFilter(this);
        
        let visibleCount = 0;
        subcategoryItems.forEach(item => {
            if (item.dataset.status === 'false') {
                item.classList.remove('d-none');
                visibleCount++;
            } else {
                item.classList.add('d-none');
            }
        });
        
        searchInput.value = '';
        noResults.classList.toggle('d-none', visibleCount > 0);
    });
    
    // Set initial active filter
    filterButtons.all.classList.add('active');
</script>
{% endblock %}